<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Reloop</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/assets/css/styles.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/assets/img/logo.png" alt="Reloop Logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="marketplace.html">Marketplace</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="leaderboard.html">Leaderboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="blog.html">Blog</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item" data-auth-required>
                        <a class="nav-link active" href="chat.html">
                            Chat
                            <span class="badge bg-danger d-none" data-unread-count></span>
                        </a>
                    </li>
                    <li class="nav-item" data-auth-required>
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item" data-profile-link>
                        <a class="nav-link" href="profile.html">Profile</a>
                    </li>
                    <li class="nav-item" data-auth-required>
                        <button class="btn btn-outline-primary" onclick="logout()">Logout</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Chat Interface -->
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Chat List -->
            <div class="col-md-4 col-lg-3 border-end p-0">
                <div class="d-flex flex-column h-100">
                    <!-- Search -->
                    <div class="p-3 border-bottom">
                        <div class="input-group">
                            <input type="search" 
                                   class="form-control" 
                                   placeholder="Search conversations..."
                                   data-search-input>
                            <button class="btn btn-outline-primary" data-search-btn>
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Chat List -->
                    <div class="flex-grow-1 overflow-auto" data-chat-list>
                        <!-- Chat items will be inserted here -->
                        <div class="text-center text-muted py-5 d-none" data-no-chats>
                            No conversations yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="col-md-8 col-lg-9 p-0">
                <div class="d-flex flex-column h-100">
                    <!-- Chat Header -->
                    <div class="p-3 border-bottom" data-chat-header>
                        <div class="d-flex align-items-center">
                            <img data-other-photo
                                 src="https://static.vecteezy.com/system/resources/thumbnails/025/869/629/small/round-profile-image-of-man-avatar-for-social-networks-fashion-beauty-blue-and-black-bright-illustration-in-trendy-style-vector.jpg" 
                                 class="rounded-circle me-2" 
                                 width="40" 
                                 height="40" 
                                 alt="">
                            <div class="flex-grow-1">
                                <h6 class="mb-0" data-other-name></h6>
                                <small class="text-muted" data-other-status></small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-light btn-sm" 
                                        type="button" 
                                        data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="#" data-view-listing>
                                            <i class="bi bi-box me-2"></i>
                                            View Listing
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" data-view-profile>
                                            <i class="bi bi-person me-2"></i>
                                            View Profile
                                        </a>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" 
                                           href="#" 
                                           data-report-user>
                                            <i class="bi bi-flag me-2"></i>
                                            Report User
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Area -->
                    <div class="flex-grow-1 overflow-auto p-3" data-messages>
                        <!-- Messages will be inserted here -->
                        <div class="text-center text-muted py-5" data-no-chat-selected>
                            Select a conversation to start chatting
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="p-3 border-top" data-message-input>
                        <form onsubmit="handleSendMessage(event)" class="d-none">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       placeholder="Type a message..."
                                       required>
                                <button class="btn btn-primary" type="submit">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report User Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reportForm">
                        <div class="mb-3">
                            <label class="form-label">Reason for Report</label>
                            <select class="form-select" required>
                                <option value="">Select a reason...</option>
                                <option value="spam">Spam</option>
                                <option value="inappropriate">Inappropriate Content</option>
                                <option value="scam">Scam Attempt</option>
                                <option value="harassment">Harassment</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Additional Details</label>
                            <textarea class="form-control" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="submitReport()">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="position-fixed top-50 start-50 translate-middle d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- App Logic -->
    <script type="module">
        import app from '/assets/js/app.js';
        import { getCurrentUser, logout } from '/assets/js/auth.js';
        import { 
            subscribeToChats,
            subscribeToMessages,
            sendMessage,
            markAsRead,
            reportUser
        } from '/assets/js/chat.js';

        // Make functions available globally
        window.logout = logout;
        window.handleSendMessage = handleSendMessage;
        window.submitReport = submitReport;

        let currentUser;
        let currentChat;
        let unsubscribeChats;
        let unsubscribeMessages;

        // Initialize page
        async function init() {
            // Check authentication
            currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = '/login.html';
                return;
            }

            try {
                showLoading();

                // Subscribe to chats
                unsubscribeChats = subscribeToChats(currentUser.uid, updateChatList);

                // Set up event handlers
                setupEventHandlers();

            } catch (error) {
                console.error('Error initializing chat:', error);
                showError('Failed to load chat data');
            } finally {
                hideLoading();
            }
        }

        // Update chat list
        function updateChatList(chats) {
            const container = document.querySelector('[data-chat-list]');
            const noChats = document.querySelector('[data-no-chats]');

            container.innerHTML = '';

            if (chats.length === 0) {
                noChats.classList.remove('d-none');
                return;
            }

            noChats.classList.add('d-none');

            chats.forEach(chat => {
                const otherUser = chat.users.find(u => u.id !== currentUser.uid);
                const div = document.createElement('div');
                div.className = `
                    chat-item 
                    p-3 
                    border-bottom 
                    ${chat.id === currentChat?.id ? 'bg-light' : ''}
                    ${chat.unread ? 'unread' : ''}
                `;
                div.dataset.chatId = chat.id;
                div.innerHTML = `
                    <div class="d-flex">
                        <img src="${otherUser.photoURL || '/assets/img/default-avatar.png'}" 
                             class="rounded-circle me-2" 
                             width="48" 
                             height="48" 
                             alt="${otherUser.name}">
                        <div class="flex-grow-1 min-width-0">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0 text-truncate">${otherUser.name}</h6>
                                <small class="text-muted">
                                    ${formatTime(chat.lastMessage?.timestamp)}
                                </small>
                            </div>
                            <p class="mb-0 text-muted text-truncate">
                                ${chat.lastMessage?.text || 'No messages yet'}
                            </p>
                        </div>
                        ${chat.unread ? '<span class="badge bg-primary rounded-pill">New</span>' : ''}
                    </div>
                `;
                div.addEventListener('click', () => selectChat(chat));
                container.appendChild(div);
            });
        }

        // Select chat
        async function selectChat(chat) {
            // Update UI state
            currentChat = chat;
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.toggle('bg-light', item.dataset.chatId === chat.id);
            });

            // Update chat header
            const otherUser = chat.users.find(u => u.id !== currentUser.uid);
            document.querySelector('[data-other-photo]').src = 
                otherUser.photoURL || '/assets/img/default-avatar.png';
            document.querySelector('[data-other-name]').textContent = otherUser.name;
            document.querySelector('[data-other-status]').textContent = 
                otherUser.online ? 'Online' : 'Offline';

            // Show message input
            document.querySelector('[data-message-input] form').classList.remove('d-none');

            // Update links
            document.querySelector('[data-view-profile]').href = 
                `/profile.html?uid=${otherUser.id}`;
            if (chat.listingId) {
                document.querySelector('[data-view-listing]').href = 
                    `/listing.html?id=${chat.listingId}`;
                document.querySelector('[data-view-listing]').classList.remove('d-none');
            } else {
                document.querySelector('[data-view-listing]').classList.add('d-none');
            }

            // Clear no chat message
            document.querySelector('[data-no-chat-selected]').classList.add('d-none');

            try {
                // Subscribe to messages
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                }
                unsubscribeMessages = subscribeToMessages(chat.id, updateMessages);

                // Mark as read
                if (chat.unread) {
                    await markAsRead(chat.id);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                showError('Failed to load messages');
            }
        }

        // Update messages
        function updateMessages(messages) {
            const container = document.querySelector('[data-messages]');
            container.innerHTML = '';

            let lastDate;
            messages.forEach(message => {
                // Add date separator if needed
                const messageDate = new Date(message.timestamp).toLocaleDateString();
                if (messageDate !== lastDate) {
                    const div = document.createElement('div');
                    div.className = 'text-center my-3';
                    div.innerHTML = `
                        <span class="badge bg-secondary">
                            ${messageDate}
                        </span>
                    `;
                    container.appendChild(div);
                    lastDate = messageDate;
                }

                // Add message
                const div = document.createElement('div');
                div.className = `
                    message 
                    ${message.userId === currentUser.uid ? 'message-out' : 'message-in'}
                    mb-3
                `;
                div.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">
                            ${message.text}
                        </div>
                        <div class="message-time">
                            ${new Date(message.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Handle send message
        async function handleSendMessage(event) {
            event.preventDefault();
            const input = event.target.querySelector('input');
            const message = input.value.trim();

            if (!message || !currentChat) return;

            try {
                await sendMessage(currentChat.id, {
                    text: message,
                    userId: currentUser.uid,
                    timestamp: new Date().toISOString()
                });

                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message');
            }
        }

        // Submit report
        async function submitReport() {
            const form = document.getElementById('reportForm');
            const reason = form.querySelector('select').value;
            const details = form.querySelector('textarea').value;

            if (!reason || !details) return;

            try {
                showLoading();

                await reportUser(currentChat.id, {
                    reason,
                    details,
                    reportedBy: currentUser.uid,
                    reportedUser: currentChat.users.find(u => u.id !== currentUser.uid).id,
                    timestamp: new Date().toISOString()
                });

                const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                modal.hide();
                form.reset();

                showSuccess('Report submitted successfully');
            } catch (error) {
                console.error('Error submitting report:', error);
                showError('Failed to submit report');
            } finally {
                hideLoading();
            }
        }

        // Set up event handlers
        function setupEventHandlers() {
            // Search
            let searchTimeout;
            document.querySelector('[data-search-input]').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('.chat-item').forEach(item => {
                    const name = item.querySelector('h6').textContent.toLowerCase();
                    item.style.display = name.includes(query) ? '' : 'none';
                });
            });

            // Report user
            document.querySelector('[data-report-user]').addEventListener('click', (e) => {
                e.preventDefault();
                new bootstrap.Modal(document.getElementById('reportModal')).show();
            });
        }

        // Format time
        function formatTime(timestamp) {
            if (!timestamp) return '';

            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 24 * 60 * 60 * 1000) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                return date.toLocaleDateString([], { weekday: 'short' });
            } else {
                return date.toLocaleDateString();
            }
        }

        // Clean up on page unload
        window.addEventListener('unload', () => {
            if (unsubscribeChats) unsubscribeChats();
            if (unsubscribeMessages) unsubscribeMessages();
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>